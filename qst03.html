<!DOCTYPE html>
<html lang="pt-br" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Passeio do cavalo</title>
        <style media="screen">
            #game {
                position: relative;
                display: inline-block;
            }

            #horse {
                position: absolute;
                width: 20px;
                height: 20px;
                background-color: #ce3d3d;
            }

            #path-svg {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }
            #path {
                stroke: #710d0d99;
            }

            #board {
                border-collapse: collapse;
            }

            #board tr td {
                box-sizing: border-box;
                vertical-align: bottom;
                z-index: 1;
                width: 60px;
                height: 60px;
                padding: 2px;
            }
            #board tr td.even {
                background-color: #fad49e;
            }
            #board tr td.odd {
                background-color: #e89c30;
            }
            #board tr td.used.even {
                background-color: #efefef;
            }
            #board tr td.used.odd {
                background-color: #a2a2a2;
            }

            #board tr td.available {
                background-color: #42a934;
            }

            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>Passeio do cavalo</h1>
        <div id="game">
            <div id="horse"></div>
            <svg id="path-svg">
                <path id="path" d="" fill="none" stroke="black" stroke-width=".05"></path>
            </svg>
            <table id="board">
            </table>
        </div>
        <script type="text/javascript">
            const BOARD_SIZE = 8;

            var horseElem = document.getElementById("horse");
            var pathSVGElem = document.getElementById("path-svg");
            var pathElem = document.getElementById("path");
            var boardElem = document.getElementById("board");

            var horsePath = [];
            var availableMovements = getValidMovements(horsePath);

            function getCell(board, pos) {
                row = board.children[pos.y];
                cell = row.children[pos.x];

                return cell;
            }

            function horseMover(board, cell, svg, path, horsePath, availableMovements, pos) {
                return function () {
                    if (!movementIsValid(horsePath, pos))
                        return;

                    for (var i = 0; i < availableMovements.length; ++i) {
                        var availableCell = getCell(board, availableMovements[i]);
                        availableCell.classList.remove("available");
                    }

                    horsePath.push(pos);

                    cell.textContent = horsePath.length;
                    cell.classList.add("used");

                    availableMovements = getValidMovements(horsePath);
                    for (var i = 0; i < availableMovements.length; ++i) {
                        var availableCell = getCell(board, availableMovements[i]);
                        availableCell.classList.add("available");
                    }

                    drawPath(svg, path, horsePath);
                }
            }

            function drawBoard(board, svg, path, horsePath, availableMovements) {
                for (var y = 0; y < BOARD_SIZE; ++y) {
                    var rowElem = document.createElement("tr");

                    for (var x = 0; x < BOARD_SIZE; ++x) {
                        var cellElem = document.createElement("td");
                        cellElem.addEventListener("click", horseMover(board, cellElem, svg, path, horsePath, availableMovements, {x: x, y: y}));

                        if ((x + y) % 2 == 0)
                            cellElem.classList.add("even");
                        else
                            cellElem.classList.add("odd");

                        rowElem.appendChild(cellElem);
                    }

                    board.appendChild(rowElem);

                    svg.setAttribute("viewBox", -0.5 + " " + -0.5 + " " + BOARD_SIZE + " " + BOARD_SIZE)
                }
            }
            function drawPath(svg, path, horsePath) {
                var cellSize = 60;
                var halfHorseSize = 10;

                if (horsePath.length > 0) {
                    var horsePathString = "M" + horsePath[0].x + "," + horsePath[0].y;
                    for (var i = 1; i < horsePath.length; ++i) {
                        horsePathString += "L" + horsePath[i].x + "," + horsePath[i].y;
                    }
                    path.setAttribute("d", horsePathString);

                    horseElem.style.left = ((horsePath[horsePath.length - 1].x + 0.5) * cellSize - halfHorseSize) + "px";
                    horseElem.style.top = ((horsePath[horsePath.length - 1].y + 0.5) * cellSize - halfHorseSize) + "px";

                    horseElem.classList.remove("hidden");
                }
                else {
                    horseElem.classList.add("hidden");
                }
            }

            function posComparator(newPos) {
                return function (pos) {
                    return (pos.x == newPos.x && pos.y == newPos.y);
                }
            }

            function posChecker(horsePath) {
                return function (pos) {
                    return movementIsValid(horsePath, pos);
                }
            }

            function getValidMovements(horsePath) {
                if (horsePath.length <= 0) {
                    var movements = [];
                    for (var y = 0; y < BOARD_SIZE; ++y) {
                        for (var x = 0; x < BOARD_SIZE; ++x) {
                            movements.push({x: x, y: y});
                        }
                    }

                    return movements;
                }

                var lastPos = horsePath[horsePath.length - 1];

                var movements = [
                    {x: lastPos.x - 1, y: lastPos.y - 2},
                    {x: lastPos.x - 1, y: lastPos.y + 2},
                    {x: lastPos.x + 1, y: lastPos.y - 2},
                    {x: lastPos.x + 1, y: lastPos.y + 2},
                    {x: lastPos.x - 2, y: lastPos.y - 1},
                    {x: lastPos.x - 2, y: lastPos.y + 1},
                    {x: lastPos.x + 2, y: lastPos.y - 1},
                    {x: lastPos.x + 2, y: lastPos.y + 1},
                ]

                movements = movements.filter(posChecker(horsePath));

                return movements;
            }

            function movementIsValid(horsePath, newPos) {
                if (horsePath.length <= 0)
                    return true;

                if (newPos.x < 0 || newPos.x >= BOARD_SIZE ||
                    newPos.y < 0 || newPos.y >= BOARD_SIZE)
                    return false;

                var lastPos = horsePath[horsePath.length - 1];
                var dx = Math.abs(lastPos.x - newPos.x);
                var dy = Math.abs(lastPos.y - newPos.y);

                if (!((dx == 1 && dy == 2) || (dx == 2 && dy == 1)))
                    return false;

                var checkPos = horsePath.find(posComparator(newPos))
                if (checkPos)
                    return false;

                return true;
            }

            drawBoard(boardElem, pathSVGElem, pathElem, horsePath, availableMovements);
            drawPath(pathSVGElem, pathElem, horsePath);
        </script>
    </body>
</html>
